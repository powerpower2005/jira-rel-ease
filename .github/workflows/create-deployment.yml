name: Manual Jira Deployment

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'ë°°í¬í•  ë¸Œëœì¹˜ ì´ë¦„'
        required: true
        default: 'main'

          
      environment:
        description: 'ë°°í¬ í™˜ê²½ '
        required: true
        default: 'stage'
        type: choice
        options:
          - prod
          - stage
          - dev

jobs:
  deploy-to-jira:
    runs-on: ubuntu-latest

    permissions:
      deployments: write
    
    steps:
      # 1. ì§€ì •ëœ ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
      - name: Checkout specified branch
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.branch }}

      # 2. Jira ì´ìŠˆ í‚¤ ì¶”ì¶œ
      - name: Extract Jira Issue Keys
        id: extract-keys
        run: |
          ISSUE_KEYS=$(git log -1 --pretty=%B | grep -oE '[A-Z]+-[0-9]+' || echo "No issue key found")
          echo "ğŸ“Œ ì¶”ì¶œëœ Jira Issue Keys: $ISSUE_KEYS"
          echo "issue-keys=$ISSUE_KEYS" >> $GITHUB_OUTPUT

      # 3. ë°°í¬ ìƒì„±
      - name: Create Deployment
        id: create-deployment
        uses: chrnorm/deployment-action@releases/v2
        with:
          token: ${{ github.token }}
          environment: ${{ github.event.inputs.environment }}
          ref: ${{ github.event.inputs.branch }}
          description: "Manual deployment from ${{ github.event.inputs.branch }} to ${{ github.event.inputs.environment }}"

      # 4. ì„ì‹œ ë°°í¬ ì‘ì—… (ëª¨ì˜ ë°°í¬)
      - name: Simulate Deployment
        run: |
          echo "Simulating deployment to ${{ github.event.inputs.environment }}..."
          mkdir -p deploy-output
          echo "Deployed from branch: ${{ github.event.inputs.branch }}" > deploy-output/info.txt
          echo "Environment: ${{ github.event.inputs.environment }}" >> deploy-output/info.txt
          echo "Jira Issue Keys: ${{ steps.extract-keys.outputs.issue-keys }}" >> deploy-output/info.txt
          sleep 5  # ì‹¤ì œ ë°°í¬ ì‹œê°„ í‰ë‚´
          echo "Deployment simulation completed!"
      

      # 5. ë°°í¬ ìƒíƒœ ì—…ë°ì´íŠ¸
      - name: Update Deployment Status
        uses: chrnorm/deployment-status@releases/v2
        if: success()
        with:
          token: ${{ github.token }}
          state: "success"
          deployment-id: ${{ steps.create-deployment.outputs.deployment_id }}
          
      - name: Update Deployment Status on Failure
        if: failure()
        uses: chrnorm/deployment-status@releases/v2
        with:
          token: ${{ github.token }}
          state: "failure"
          deployment-id: ${{ steps.create-deployment.outputs.deployment_id }}
