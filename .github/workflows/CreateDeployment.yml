
name: Update Jira Deployment

on:
  

jobs:
  deploy-infra:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev-cluster, staging-cluster, prod-cluster]
    environment: ${{ matrix.environment }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create GitHub Deployment
        id: create-deployment
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: "${{ matrix.environment }}",
              description: "Deploying infrastructure to ${{ matrix.environment }} with version ${{ github.sha }}",
              payload: JSON.stringify({
                infra_version: "v1.0.0",
                cluster_name: "${{ matrix.environment }}",
                deployed_by: "${{ github.actor }}"
              }),
              required_contexts: []
            });
            return response.data.id;
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy Infrastructure
        run: |
          echo "Deploying to ${{ matrix.environment }}..."
          # ì˜ˆ: kubectl apply -f infra-config.yaml

      - name: Update Deployment Status
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.create-deployment.outputs.result }},
              state: "${{ job.status == 'success' && 'success' || 'failure' }}",
              description: "Infrastructure deployment to ${{ matrix.environment }} ${{ job.status }}",
              environment_url: "https://infra.${{ matrix.environment }}.example.com"
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Jira Status
        uses: atlassian/gajira-transition@master
        with:
          issue: ${{ github.event.commits[0].message | regex_search('([A-Z]+-\d+)', 1) }}
          transition: "Deployed"
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

  deploy-service:
    needs: deploy-infra
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, staging, prod]
    environment: ${{ matrix.environment }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Create GitHub Deployment
        id: create-deployment
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: "${{ matrix.environment }}",
              description: "Deploying service to ${{ matrix.environment }} with commit ${{ github.sha }}",
              payload: JSON.stringify({
                service_version: "v2.1.0",
                farm_name: "${{ matrix.environment }}-farm",
                deployed_by: "${{ github.actor }}"
              }),
              required_contexts: []
            });
            return response.data.id;
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy Service
        run: |
          echo "Deploying to ${{ matrix.environment }} farm..."
          # ì˜ˆ: helm upgrade my-app ./helm-chart

      - name: Update Deployment Status
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: ${{ steps.create-deployment.outputs.result }},
              state: "${{ job.status == 'success' && 'success' || 'failure' }}",
              description: "Service deployment to ${{ matrix.environment }} farm ${{ job.status }}",
              environment_url: "https://app.${{ matrix.environment }}.example.com"
            });
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Jira Status
        uses: atlassian/gajira-transition@master
        with:
          issue: ${{ github.event.commits[0].message | regex_search('([A-Z]+-\d+)', 1) }}
          transition: "Done"
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: jira
    steps:
      - name: Checkout target repository
        id: checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repo }}
          path: target-repo
          fetch-depth: 0
          fetch-tags: true
          token: ${{ github.event.inputs.use_pat == 'true' && secrets.REPO_PAT || github.token }}

      - name: Notify checkout
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          REPO: ${{ github.event.inputs.repo }}
        run: |
          MSG="ğŸ“¦ ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ ì™„ë£Œ: $REPO"
          echo "$MSG"
          curl -X POST --data-urlencode \
            "payload={\"username\":\"jira-bot\",\"text\":\"$MSG\",\"icon_emoji\":\":package:\"}" "$SLACK_WEBHOOK"

      - name: Extract Jira tickets from commits 
        id: extract
        run: |
          VERSION="${{ github.event.inputs.version }}"
          FROM_TAG="${{ github.event.inputs.from_tag }}"
          if [[ -z "$FROM_TAG" ]]; then
            FROM_TAG="v${VERSION}-dev"
          fi
          TO_TAG="${VERSION}"
          echo "ğŸ” ì»¤ë°‹ ë²”ìœ„: $FROM_TAG .. $TO_TAG"

          git -C target-repo rev-parse "$FROM_TAG" >/dev/null 2>&1 || {
            echo "slack-message=âŒ íƒœê·¸ $FROM_TAG ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 1
          }

          git -C target-repo rev-parse "$TO_TAG" >/dev/null 2>&1 || {
            echo "slack-message=âŒ íƒœê·¸ $TO_TAG ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 1
          }

          COMMITS=$(git -C target-repo log --pretty=format:"%h|%an|%s" ${FROM_TAG}..${TO_TAG})
          if [[ -z "$COMMITS" ]]; then
            echo "slack-message=âš ï¸ $FROM_TAG ~ $TO_TAG ì‚¬ì´ì— ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            echo "tickets=" >> $GITHUB_OUTPUT
            exit 0
          fi

          TICKET_PATTERN='[A-Z][A-Z0-9]+-[0-9]+'
          TICKETS=$(echo "$COMMITS" | grep -o -E "$TICKET_PATTERN" | sort -u | tr '\n' ' ')
          COMMITS_BASE64=$(echo "$COMMITS" | base64 -w 0)

          echo "tickets=$TICKETS" >> $GITHUB_OUTPUT
          echo "commits_base64=$COMMITS_BASE64" >> $GITHUB_OUTPUT
          echo "slack-message=ğŸ” Jira í‹°ì¼“ ë° ì»¤ë°‹ ì¶”ì¶œ ì™„ë£Œ: $TICKETS" >> $GITHUB_OUTPUT

      - name: Notify ticket extraction
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          MSG: ${{ steps.extract.outputs.slack-message }}
        run: |
          echo "$MSG"
          curl -X POST --data-urlencode \
            "payload={\"username\":\"jira-bot\",\"text\":\"$MSG\",\"icon_emoji\":\":mag:\"}" "$SLACK_WEBHOOK"


            - name: Create FixVersion if not exists
              id: ensure-fixversion
              env:
                DOMAIN: ${{ secrets.DOMAIN }}
                USER: ${{ secrets.USER }}
                API_TOKEN: ${{ secrets.API_TOKEN }}
                SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
              run: |
                VERSION="${{ github.event.inputs.version }}"
                PREFIX="${{ github.event.inputs.fix_prefix }}"
                FIX_NAME="${PREFIX} ${VERSION}"
                TICKETS="${{ steps.extract.outputs.tickets }}"
                PROJECT_KEY=$(echo "$TICKETS" | awk '{print $1}' | cut -d'-' -f1)
      
                echo "ğŸ” í”„ë¡œì íŠ¸ í‚¤: $PROJECT_KEY"
                echo "ğŸ¯ FixVersion: $FIX_NAME"
      
                # FixVersion ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$USER:$API_TOKEN" \
                  -H "Accept: application/json" \
                  "$DOMAIN/rest/api/3/project/$PROJECT_KEY/versions")
      
                if [[ "$RESPONSE" != "200" ]]; then
                  echo "âŒ FixVersion ì¡°íšŒ ì‹¤íŒ¨ (ì½”ë“œ: $RESPONSE)"
                  cat response.json
                  MSG="âŒ *FixVersion ì¡°íšŒ ì‹¤íŒ¨*\nìƒíƒœ ì½”ë“œ: $RESPONSE\nì‘ë‹µ:\n$(cat response.json)"
                  curl -X POST --data-urlencode "payload={\"username\": \"jira-bot\", \"text\": \"$MSG\", \"icon_emoji\": \":x:\"}" "$SLACK_WEBHOOK"
                  exit 1
                fi
      
                EXISTING=$(jq -r '.[].name' < response.json | grep -Fx "$FIX_NAME")
      
                if [[ -z "$EXISTING" ]]; then
                  echo "ğŸ”§ FixVersion $FIX_NAME ì—†ìŒ â†’ ìƒì„±"
      
                  RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$USER:$API_TOKEN" \
                    -H "Content-Type: application/json" \
                    -X POST \
                    --data "{
                      \"name\": \"$FIX_NAME\",
                      \"project\": \"$PROJECT_KEY\",
                      \"description\": \"ìë™ ìƒì„±ëœ FixVersion\",
                      \"released\": false
                    }" "$DOMAIN/rest/api/3/version")
      
                  if [[ "$RESPONSE" != "201" ]]; then
                    echo "âŒ FixVersion ìƒì„± ì‹¤íŒ¨ (ì½”ë“œ: $RESPONSE)"
                    cat response.json
                    MSG="âŒ *FixVersion ìƒì„± ì‹¤íŒ¨*\nìƒíƒœ ì½”ë“œ: $RESPONSE\nì‘ë‹µ:\n$(cat response.json)"
                    curl -X POST --data-urlencode "payload={\"username\": \"jira-bot\", \"text\": \"$MSG\", \"icon_emoji\": \":x:\"}" "$SLACK_WEBHOOK"
                    exit 1
                  fi
                  echo "âœ… FixVersion $FIX_NAME ìƒì„± ì™„ë£Œ"
                else
                  echo "âœ… FixVersion $FIX_NAME ì´ë¯¸ ì¡´ì¬"
                fi


            - name: Update Jira Fix Versions
              id: update-jira
              env:
                DOMAIN: ${{ secrets.DOMAIN }}
                USER: ${{ secrets.USER }}
                API_TOKEN: ${{ secrets.API_TOKEN }}
                SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
                VERSION: ${{ github.event.inputs.version }}
              run: |
                IFS=' ' read -ra TICKETS <<< "${{ steps.extract.outputs.tickets }}"
                if [[ -z "${TICKETS[*]}" ]]; then
                  echo "slack-message=â„¹ï¸ Jira í‹°ì¼“ ì—†ìŒ. ì—…ë°ì´íŠ¸ ìƒëµ." >> $GITHUB_OUTPUT
                  exit 0
                fi
      
                FAILED_TICKETS=()
                for TICKET in "${TICKETS[@]}"; do
                  echo "â¡ï¸ $TICKET FixVersion ì—…ë°ì´íŠ¸ ì¤‘..."
                  RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$USER:$API_TOKEN" \
                    -X PUT -H "Content-Type: application/json" \
                    --data "{\"update\":{\"fixVersions\":[{\"add\":{\"name\":\"$VERSION\"}}]}}" \
                    "$DOMAIN/rest/api/2/issue/$TICKET")
      
                  if [[ "$RESPONSE" == "204" ]]; then
                    echo "âœ… $TICKET ì—…ë°ì´íŠ¸ ì„±ê³µ"
                  elif [[ "$RESPONSE" == "401" || "$RESPONSE" == "403" ]]; then
                    echo "âŒ Jira ì¸ì¦ ì‹¤íŒ¨ ($RESPONSE)"
                    cat response.json
                    MSG="âŒ *Jira ì¸ì¦ ì‹¤íŒ¨*\ní‹°ì¼“: $TICKET\nìƒíƒœ ì½”ë“œ: $RESPONSE\nì‘ë‹µ:\n$(cat response.json)"
                    curl -X POST --data-urlencode "payload={\"username\": \"jira-bot\", \"text\": \"$MSG\", \"icon_emoji\": \":x:\"}" "$SLACK_WEBHOOK"
                    exit 1
                  else
                    echo "âŒ $TICKET ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (ì½”ë“œ: $RESPONSE)"
                    cat response.json
                    MSG="âš ï¸ *FixVersion ì—…ë°ì´íŠ¸ ì‹¤íŒ¨*\ní‹°ì¼“: $TICKET\nìƒíƒœ ì½”ë“œ: $RESPONSE\nì‘ë‹µ:\n$(cat response.json)"
                    curl -X POST --data-urlencode "payload={\"username\": \"jira-bot\", \"text\": \"$MSG\", \"icon_emoji\": \":warning:\"}" "$SLACK_WEBHOOK"
                    FAILED_TICKETS+=("$TICKET")
                  fi
                  sleep 1
                done
      
                if [[ ${#FAILED_TICKETS[@]} -ne 0 ]]; then
                  echo "slack-message=âš ï¸ ì¼ë¶€ Jira í‹°ì¼“ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${FAILED_TICKETS[*]}" >> $GITHUB_OUTPUT
                  exit 1
                fi
      
                echo "slack-message=ğŸ‰ Jira Fix Version ì—…ë°ì´íŠ¸ ì„±ê³µ" >> $GITHUB_OUTPUT
>>>>>>> parent of f44e6d2 (Update AfterReleaseTagJob.yml)

      - name: Notify Jira update
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          MSG: ${{ steps.update-jira.outputs.slack-message }}
        run: |
          echo "$MSG"
          curl -X POST --data-urlencode \
            "payload={\"username\":\"jira-bot\",\"text\":\"$MSG\",\"icon_emoji\":\":rocket:\"}" "$SLACK_WEBHOOK"

      - name: Send summary Slack message
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          VERSION: ${{ github.event.inputs.version }}
          TICKETS: ${{ steps.extract.outputs.tickets }}
          COMMITS_BASE64: ${{ steps.extract.outputs.commits_base64 }}
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          if [[ -z "$TICKETS" ]]; then
            MSG="â„¹ï¸ No Jira tickets found for version $VERSION. No updates made."
          else
            COMMITS=$(echo "$COMMITS_BASE64" | base64 -d)
            FIXVERSION_LINK="$DOMAIN/issues/?jql=fixVersion=${VERSION}"

            MSG="ğŸ“¦ *Release $VERSION FixVersion ìµœì¢… ìš”ì•½*\n\n"
            MSG+="ğŸ”— <${FIXVERSION_LINK}|FixVersion: $VERSION>\n\n"
            MSG+="ğŸ« *í‹°ì¼“ ëª©ë¡:*\n"
            for TICKET in $TICKETS; do
              MSG+="â€¢ <${DOMAIN}/browse/${TICKET}|${TICKET}>\n"
            done

            MSG+="\nğŸ”€ *í¬í•¨ëœ ì»¤ë°‹ (ì‘ì„±ì í¬í•¨):*\n"
            while IFS='|' read -r HASH AUTHOR MESSAGE; do
              MSG+="â€¢ $HASH ($AUTHOR): $MESSAGE\n"
            done <<< "$COMMITS"
          fi

          echo "$MSG"
          curl -X POST --data-urlencode \
            "payload={\"username\":\"jira-bot\",\"text\":\"$MSG\",\"icon_emoji\":\":memo:\"}" "$SLACK_WEBHOOK"
