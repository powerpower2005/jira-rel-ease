name: Update Jira Fix Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ìŠ¤ ë²„ì „ (ì˜ˆ: 1.2.0)'
        required: true
      repo:
        description: 'ëŒ€ìƒ ë ˆí¬ (ì˜ˆ: owner/repo)'
        required: true
      use_pat:
        description: 'ì™¸ë¶€ ë ˆí¬ ì ‘ê·¼ì— PAT ì‚¬ìš©í• ì§€ ì—¬ë¶€ (true/false)'
        required: true
        default: 'false'

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: jira
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repo }}
          path: target-repo
          fetch-depth: 0
          fetch-tags: true
          token: ${{ github.event.inputs.use_pat == 'true' && secrets.REPO_PAT || github.token }}

      - name: Extract Jira tickets from commits
        id: extract
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DEV_VERSION="v${VERSION}-dev"
          VERSION_TAG="${VERSION}"
          TICKET_PATTERN='[A-Z][A-Z0-9]+-[0-9]+'

          echo "ğŸ” ë²„ì „ ë²”ìœ„: $DEV_VERSION .. $VERSION_TAG"

          git -C target-repo rev-parse "$DEV_VERSION" >/dev/null 2>&1 || {
            echo "slack-message=âŒ íƒœê·¸ $DEV_VERSION ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 1
          }

          git -C target-repo rev-parse "$VERSION_TAG" >/dev/null 2>&1 || {
            echo "slack-message=âŒ íƒœê·¸ $VERSION_TAG ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            exit 1
          }

          COMMITS=$(git -C target-repo log --pretty=format:"%h %s" ${DEV_VERSION}..${VERSION_TAG})
          if [[ -z "$COMMITS" ]]; then
            echo "slack-message=âš ï¸ ${DEV_VERSION} ~ ${VERSION_TAG} ì‚¬ì´ì— ì»¤ë°‹ì´ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            echo "tickets=" >> $GITHUB_OUTPUT
            exit 0
          fi

          TICKETS=$(echo "$COMMITS" | grep -o -E "$TICKET_PATTERN" | sort -u | tr '\n' ' ')
          COMMITS_BASE64=$(echo "$COMMITS" | base64 -w 0)

          echo "tickets=$TICKETS" >> $GITHUB_OUTPUT
          echo "commits_base64=$COMMITS_BASE64" >> $GITHUB_OUTPUT
          echo "slack-message=ğŸ” Jira í‹°ì¼“ ë° ì»¤ë°‹ ì¶”ì¶œ ì™„ë£Œ: $TICKETS" >> $GITHUB_OUTPUT

      - name: Send Slack Notification
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          VERSION: ${{ github.event.inputs.version }}
          TICKETS: ${{ steps.extract.outputs.tickets }}
          COMMITS_BASE64: ${{ steps.extract.outputs.commits_base64 }}
        run: |
          if [[ -z "$TICKETS" ]]; then
            MSG="â„¹ï¸ No Jira tickets found for version $VERSION. No updates made."
          else
            COMMITS=$(echo "$COMMITS_BASE64" | base64 -d)
            MSG="ğŸ“¦ *Release $VERSION FixVersion ì—…ë°ì´íŠ¸ ì™„ë£Œ*\n\n"
            MSG+="ğŸ« *í‹°ì¼“ ëª©ë¡:*\n"
            for TICKET in $TICKETS; do
              MSG+="â€¢ $TICKET\n"
            done
            MSG+="\nğŸ”€ *í¬í•¨ëœ ì»¤ë°‹ (ì´ $(echo "$COMMITS" | wc -l)ê°œ):*\n"
            while IFS= read -r COMMIT; do
              MSG+="â€¢ $COMMIT\n"
            done <<< "$COMMITS"
          fi

          curl -X POST --data-urlencode "payload={
            \"username\": \"jira-bot\",
            \"text\": \"$MSG\",
            \"icon_emoji\": \":package:\"
          }" "$SLACK_WEBHOOK"
