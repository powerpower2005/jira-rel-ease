name: Update Jira Fix Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Î¶¥Î¶¨Ïä§ Î≤ÑÏ†Ñ (Ïòà: 1.2.0)'
        required: true
      repo:
        description: 'Ï∂îÏ†ÅÌï† Î†àÌè¨ÏßÄÌÜ†Î¶¨ (Ïòà: owner/repo)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: jira  # üîÅ slack ‚Üí jira
    steps:
      - name: Clone repository
        id: clone
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          echo "üì¶ Ï†ÄÏû•ÏÜå ${{ github.event.inputs.repo }} ÌÅ¥Î°† ÏãúÏûë"
          git clone --depth=1 "https://github.com/${{ github.event.inputs.repo }}.git" target-repo
          cd target-repo && git fetch --tags
          MSG="üì¶ Ï†ÄÏû•ÏÜå ÌÅ¥Î°† ÏôÑÎ£å"
          echo "$MSG"
          curl -X POST --data-urlencode "payload={
            \"username\": \"jira-bot\",
            \"text\": \"$MSG\",
            \"icon_emoji\": \":package:\"
          }" "$SLACK_WEBHOOK"

      - name: Extract Jira tickets from commits
        id: extract
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DEV_VERSION="v${VERSION}-dev"
          VERSION_TAG="${VERSION}"
          TICKET_PATTERN='[A-Z][A-Z0-9]+-[0-9]+'

          echo "üîç Î≤ÑÏ†Ñ Î≤îÏúÑ: $DEV_VERSION .. $VERSION_TAG"

          git -C target-repo rev-parse "$DEV_VERSION" >/dev/null 2>&1 || {
            MSG="‚ùå ÌÉúÍ∑∏ $DEV_VERSION Ïù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§."
            echo "$MSG"
            curl -X POST --data-urlencode "payload={
              \"username\": \"jira-bot\",
              \"text\": \"$MSG\",
              \"icon_emoji\": \":x:\"
            }" "$SLACK_WEBHOOK"
            exit 1
          }

          git -C target-repo rev-parse "$VERSION_TAG" >/dev/null 2>&1 || {
            MSG="‚ùå ÌÉúÍ∑∏ $VERSION_TAG Ïù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§."
            echo "$MSG"
            curl -X POST --data-urlencode "payload={
              \"username\": \"jira-bot\",
              \"text\": \"$MSG\",
              \"icon_emoji\": \":x:\"
            }" "$SLACK_WEBHOOK"
            exit 1
          }

          COMMITS=$(git -C target-repo log --pretty=format:"%s" ${DEV_VERSION}..${VERSION_TAG})
          if [[ -z "$COMMITS" ]]; then
            MSG="‚ö†Ô∏è ${DEV_VERSION} ~ ${VERSION_TAG} ÏÇ¨Ïù¥Ïóê Ïª§Î∞ãÏù¥ ÏóÜÏäµÎãàÎã§."
            echo "$MSG"
            curl -X POST --data-urlencode "payload={
              \"username\": \"jira-bot\",
              \"text\": \"$MSG\",
              \"icon_emoji\": \":warning:\"
            }" "$SLACK_WEBHOOK"
            echo "tickets=" >> $GITHUB_OUTPUT
            exit 0
          fi

          TICKETS=$(echo "$COMMITS" | grep -o -E "$TICKET_PATTERN" | sort -u | tr '\n' ' ')
          echo "tickets=$TICKETS" >> $GITHUB_OUTPUT

          MSG="üîç Jira Ìã∞Ïºì Ï∂îÏ∂ú ÏôÑÎ£å: $TICKETS"
          echo "$MSG"
          curl -X POST --data-urlencode "payload={
            \"username\": \"jira-bot\",
            \"text\": \"$MSG\",
            \"icon_emoji\": \":mag:\"
          }" "$SLACK_WEBHOOK"

      - name: Update Jira Fix Versions
        id: update-jira
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          USER: ${{ secrets.USER }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          IFS=' ' read -ra TICKETS <<< "${{ steps.extract.outputs.tickets }}"
          if [[ -z "${TICKETS[*]}" ]]; then
            echo "‚ÑπÔ∏è Jira Ìã∞Ïºì ÏóÜÏùå. ÏóÖÎç∞Ïù¥Ìä∏ ÏÉùÎûµ."
            exit 0
          fi

          echo "üéØ Jira ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë: Î≤ÑÏ†Ñ $VERSION"
          FAILED_TICKETS=()

          for TICKET in "${TICKETS[@]}"; do
            echo "‚û°Ô∏è $TICKET ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÎèÑ"
            RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$USER:$API_TOKEN" \
              -X PUT \
              -H "Content-Type: application/json" \
              --data "{\"update\":{\"fixVersions\":[{\"add\":{\"name\":\"$VERSION\"}}]}}" \
              "$DOMAIN/rest/api/2/issue/$TICKET")

            if [[ "$RESPONSE" == "204" ]]; then
              echo "‚úÖ $TICKET ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ"
            elif [[ "$RESPONSE" == "401" || "$RESPONSE" == "403" ]]; then
              MSG="‚ùå Jira Ïù∏Ï¶ù Ïã§Ìå® ($RESPONSE) - ÏÇ¨Ïö©Ïûê ÎòêÎäî ÌÜ†ÌÅ∞ ÌôïÏù∏ ÌïÑÏöî"
              echo "$MSG"
              curl -X POST --data-urlencode "payload={
                \"username\": \"jira-bot\",
                \"text\": \"$MSG\",
                \"icon_emoji\": \":x:\"
              }" "$SLACK_WEBHOOK"
              exit 1
            else
              echo "‚ùå $TICKET Ïã§Ìå® (ÏùëÎãµ: $RESPONSE)"
              FAILED_TICKETS+=("$TICKET")
            fi
            sleep 1
          done

          if [[ ${#FAILED_TICKETS[@]} -ne 0 ]]; then
            MSG="‚ö†Ô∏è ÏùºÎ∂Ä Ìã∞Ïºì Ïã§Ìå®: ${FAILED_TICKETS[*]}"
            echo "$MSG"
            curl -X POST --data-urlencode "payload={
              \"username\": \"jira-bot\",
              \"text\": \"$MSG\",
              \"icon_emoji\": \":warning:\"
            }" "$SLACK_WEBHOOK"
            exit 1
          fi

          MSG="üéâ Jira Fix Version ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å: ${TICKETS[*]}"
          echo "$MSG"
          curl -X POST --data-urlencode "payload={
            \"username\": \"jira-bot\",
            \"text\": \"$MSG\",
            \"icon_emoji\": \":white_check_mark:\"
          }" "$SLACK_WEBHOOK"
