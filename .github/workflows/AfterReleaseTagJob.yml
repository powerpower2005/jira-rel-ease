name: Update Jira Fix Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ë¦´ë¦¬ìŠ¤ ë²„ì „ (ì˜ˆ: 1.2.0)'
        required: true
      repo:
        description: 'ì¶”ì í•  ë ˆí¬ì§€í† ë¦¬ (ì˜ˆ: org/repo)'
        required: true

jobs:
  update-fix-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target repository
        run: |
          git clone --depth=1 "https://github.com/${{ github.event.inputs.repo }}.git" target-repo
          cd target-repo && git fetch --tags

      - name: Notify - Checkout ì™„ë£Œ
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"ğŸ“¦ ì €ì¥ì†Œ \`${{ github.event.inputs.repo }}\` ì²´í¬ì•„ì›ƒ ì™„ë£Œ\"
          }" "$SLACK_WEBHOOK_URL"

      - name: Extract commits and Jira tickets
        id: extract
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DEV_VERSION="v${VERSION}-dev"
          TICKET_PATTERN='[A-Z][A-Z0-9]+-[0-9]+'

          COMMITS=$(git -C target-repo log --pretty=format:"%s" ${DEV_VERSION}..${VERSION})
          TICKETS=$(echo "$COMMITS" | grep -o -E "$TICKET_PATTERN" | sort -u | tr '\n' ' ')
          echo "tickets=$TICKETS" >> $GITHUB_OUTPUT

      - name: Notify - ì»¤ë°‹ ë° Jira í‹°ì¼“ ì¶”ì¶œ ì™„ë£Œ
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"ğŸ” ì»¤ë°‹ ë° Jira í‹°ì¼“ ì¶”ì¶œ ì™„ë£Œ\"
          }" "$SLACK_WEBHOOK_URL"

      - name: Update Jira Fix Versions
        id: update-jira
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          IFS=' ' read -ra TICKETS <<< "${{ steps.extract.outputs.tickets }}"
          FAILED_TICKETS=()

          for TICKET in "${TICKETS[@]}"; do
            RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$JIRA_USER:$JIRA_API_TOKEN" \
              -X PUT \
              -H "Content-Type: application/json" \
              --data "{\"update\":{\"fixVersions\":[{\"add\":{\"name\":\"$VERSION\"}}]}}" \
              "$JIRA_BASE_URL/rest/api/2/issue/$TICKET")

            if [[ "$RESPONSE" == "204" ]]; then
              echo "âœ… $TICKET updated"
            else
              echo "âŒ $TICKET failed"
              cat response.json
              FAILED_TICKETS+=("$TICKET")
            fi
            sleep 1
          done

          if [[ ${#FAILED_TICKETS[@]} -ne 0 ]]; then
            echo "SLACK_MESSAGE=âš ï¸ Jira ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${FAILED_TICKETS[*]}" >> $GITHUB_ENV
            exit 1
          fi

          echo "SLACK_MESSAGE=ğŸ‰ Jira Fix Version ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${TICKETS[*]}" >> $GITHUB_ENV

      - name: Notify - Jira ì—…ë°ì´íŠ¸ ì„±ê³µ
        if: success() && steps.update-jira.conclusion == 'success'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_MESSAGE: ${{ env.SLACK_MESSAGE }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"$SLACK_MESSAGE\"
          }" "$SLACK_WEBHOOK_URL"

      - name: Notify - Jira ì—…ë°ì´íŠ¸ ì‹¤íŒ¨
        if: failure() && steps.update-jira.conclusion == 'failure'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_MESSAGE: ${{ env.SLACK_MESSAGE }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"$SLACK_MESSAGE\"
          }" "$SLACK_WEBHOOK_URL"

      - name: Notify - ì „ì²´ ì™„ë£Œ
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"âœ… ì „ì²´ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ\"
          }" "$SLACK_WEBHOOK_URL"

      - name: Notify - ì „ì²´ ì‹¤íŒ¨
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data "{
            \"text\": \"âŒ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨. ìƒì„¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\"
          }" "$SLACK_WEBHOOK_URL"
