name: Update Jira Fix Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Î¶¥Î¶¨Ïä§ Î≤ÑÏ†Ñ (Ïòà: 1.2.0)'
        required: true
      repo:
        description: 'ÎåÄÏÉÅ Î†àÌè¨ (Ïòà: owner/repo)'
        required: true
      use_pat:
        description: 'Ïô∏Î∂Ä Î†àÌè¨ Ï†ëÍ∑ºÏóê PAT ÏÇ¨Ïö©Ìï†ÏßÄ Ïó¨Î∂Ä (true/false)'
        required: true
        default: 'false'

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: jira
    steps:
      - name: Checkout target repository
        id: checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repo }}
          path: target-repo
          fetch-depth: 0
          fetch-tags: true
          token: ${{ github.event.inputs.use_pat == 'true' && secrets.REPO_PAT || github.token }}

      - name: Notify checkout
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          REPO: ${{ github.event.inputs.repo }}
        run: |
          MSG="üì¶ Î†àÌè¨ÏßÄÌÜ†Î¶¨ Ï≤¥ÌÅ¨ÏïÑÏõÉ ÏôÑÎ£å: $REPO"
          curl -X POST --data-urlencode "payload={\"username\":\"jira-bot\",\"text\":\"$MSG\",\"icon_emoji\":\":package:\"}" "$SLACK_WEBHOOK"

      - name: Extract Jira tickets from commits 
        id: extract
        run: |
          VERSION="${{ github.event.inputs.version }}"
          DEV_VERSION="v${VERSION}-dev"
          VERSION_TAG="${VERSION}"
          TICKET_PATTERN='[A-Z][A-Z0-9]+-[0-9]+'

          echo "üîç Î≤ÑÏ†Ñ Î≤îÏúÑ: $DEV_VERSION .. $VERSION_TAG"

          git -C target-repo rev-parse "$DEV_VERSION" >/dev/null 2>&1 || {
            echo "slack-message=‚ùå ÌÉúÍ∑∏ $DEV_VERSION Ïù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§." >> $GITHUB_OUTPUT
            exit 1
          }

          git -C target-repo rev-parse "$VERSION_TAG" >/dev/null 2>&1 || {
            echo "slack-message=‚ùå ÌÉúÍ∑∏ $VERSION_TAG Ïù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§." >> $GITHUB_OUTPUT
            exit 1
          }

          COMMITS=$(git -C target-repo log --pretty=format:"%h %s" ${DEV_VERSION}..${VERSION_TAG})
          if [[ -z "$COMMITS" ]]; then
            echo "slack-message=‚ö†Ô∏è ${DEV_VERSION} ~ ${VERSION_TAG} ÏÇ¨Ïù¥Ïóê Ïª§Î∞ãÏù¥ ÏóÜÏäµÎãàÎã§." >> $GITHUB_OUTPUT
            echo "tickets=" >> $GITHUB_OUTPUT
            exit 0
          fi

          TICKETS=$(echo "$COMMITS" | grep -o -E "$TICKET_PATTERN" | sort -u | tr '\n' ' ')
          COMMITS_BASE64=$(echo "$COMMITS" | base64 -w 0)

          echo "tickets=$TICKETS" >> $GITHUB_OUTPUT
          echo "commits_base64=$COMMITS_BASE64" >> $GITHUB_OUTPUT
          echo "slack-message=üîç Jira Ìã∞Ïºì Î∞è Ïª§Î∞ã Ï∂îÏ∂ú ÏôÑÎ£å: $TICKETS" >> $GITHUB_OUTPUT

      - name: Notify ticket extraction
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          MSG: ${{ steps.extract.outputs.slack-message }}
        run: |
          printf '%s\n' "$MSG"
          curl -X POST --data-urlencode "payload={\"username\":\"jira-bot\",\"text\":\"$MSG\",\"icon_emoji\":\":mag:\"}" "$SLACK_WEBHOOK"

<<<<<<< HEAD
      - name: Update Jira Fix Versions
        id: update-jira
        env:
          DOMAIN: ${{ secrets.DOMAIN }}
          USER: ${{ secrets.USER }}
          API_TOKEN: ${{ secrets.API_TOKEN }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          IFS=' ' read -ra TICKETS <<< "${{ steps.extract.outputs.tickets }}"
          if [[ -z "${TICKETS[*]}" ]]; then
            echo "slack-message=‚ÑπÔ∏è Jira Ìã∞Ïºì ÏóÜÏùå. ÏóÖÎç∞Ïù¥Ìä∏ ÏÉùÎûµ." >> $GITHUB_OUTPUT
            exit 0
          fi

          FAILED_TICKETS=()
          for TICKET in "${TICKETS[@]}"; do
            RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$USER:$API_TOKEN" \
              -X PUT -H "Content-Type: application/json" \
              --data "{\"update\":{\"fixVersions\":[{\"add\":{\"name\":\"$VERSION\"}}]}}" \
              "$DOMAIN/rest/api/2/issue/$TICKET")

            if [[ "$RESPONSE" == "204" ]]; then
              continue
            elif [[ "$RESPONSE" == "401" || "$RESPONSE" == "403" ]]; then
              echo "slack-message=‚ùå Jira Ïù∏Ï¶ù Ïã§Ìå® ($RESPONSE)" >> $GITHUB_OUTPUT
              exit 1
            else
              FAILED_TICKETS+=("$TICKET")
            fi
            sleep 1
          done

          if [[ ${#FAILED_TICKETS[@]} -ne 0 ]]; then
            echo "slack-message=‚ö†Ô∏è ÏùºÎ∂Ä Jira Ìã∞Ïºì ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${FAILED_TICKETS[*]}" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "slack-message=üéâ Jira Fix Version ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ" >> $GITHUB_OUTPUT
=======
            - name: Create FixVersion if not exists
              id: ensure-fixversion
              env:
                DOMAIN: ${{ secrets.DOMAIN }}
                USER: ${{ secrets.USER }}
                API_TOKEN: ${{ secrets.API_TOKEN }}
                SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
              run: |
                VERSION="${{ github.event.inputs.version }}"
                PREFIX="${{ github.event.inputs.fix_prefix }}"
                FIX_NAME="${PREFIX} ${VERSION}"
                TICKETS="${{ steps.extract.outputs.tickets }}"
                PROJECT_KEY=$(echo "$TICKETS" | awk '{print $1}' | cut -d'-' -f1)
      
                echo "üîé ÌîÑÎ°úÏ†ùÌä∏ ÌÇ§: $PROJECT_KEY"
                echo "üéØ FixVersion: $FIX_NAME"
      
                # FixVersion Ï°¥Ïû¨ Ïó¨Î∂Ä ÌôïÏù∏
                RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$USER:$API_TOKEN" \
                  -H "Accept: application/json" \
                  "$DOMAIN/rest/api/3/project/$PROJECT_KEY/versions")
      
                if [[ "$RESPONSE" != "200" ]]; then
                  echo "‚ùå FixVersion Ï°∞Ìöå Ïã§Ìå® (ÏΩîÎìú: $RESPONSE)"
                  cat response.json
                  MSG="‚ùå *FixVersion Ï°∞Ìöå Ïã§Ìå®*\nÏÉÅÌÉú ÏΩîÎìú: $RESPONSE\nÏùëÎãµ:\n$(cat response.json)"
                  curl -X POST --data-urlencode "payload={\"username\": \"jira-bot\", \"text\": \"$MSG\", \"icon_emoji\": \":x:\"}" "$SLACK_WEBHOOK"
                  exit 1
                fi
      
                EXISTING=$(jq -r '.[].name' < response.json | grep -Fx "$FIX_NAME")
      
                if [[ -z "$EXISTING" ]]; then
                  echo "üîß FixVersion $FIX_NAME ÏóÜÏùå ‚Üí ÏÉùÏÑ±"
      
                  RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$USER:$API_TOKEN" \
                    -H "Content-Type: application/json" \
                    -X POST \
                    --data "{
                      \"name\": \"$FIX_NAME\",
                      \"project\": \"$PROJECT_KEY\",
                      \"description\": \"ÏûêÎèô ÏÉùÏÑ±Îêú FixVersion\",
                      \"released\": false
                    }" "$DOMAIN/rest/api/3/version")
      
                  if [[ "$RESPONSE" != "201" ]]; then
                    echo "‚ùå FixVersion ÏÉùÏÑ± Ïã§Ìå® (ÏΩîÎìú: $RESPONSE)"
                    cat response.json
                    MSG="‚ùå *FixVersion ÏÉùÏÑ± Ïã§Ìå®*\nÏÉÅÌÉú ÏΩîÎìú: $RESPONSE\nÏùëÎãµ:\n$(cat response.json)"
                    curl -X POST --data-urlencode "payload={\"username\": \"jira-bot\", \"text\": \"$MSG\", \"icon_emoji\": \":x:\"}" "$SLACK_WEBHOOK"
                    exit 1
                  fi
                  echo "‚úÖ FixVersion $FIX_NAME ÏÉùÏÑ± ÏôÑÎ£å"
                else
                  echo "‚úÖ FixVersion $FIX_NAME Ïù¥ÎØ∏ Ï°¥Ïû¨"
                fi


            - name: Update Jira Fix Versions
              id: update-jira
              env:
                DOMAIN: ${{ secrets.DOMAIN }}
                USER: ${{ secrets.USER }}
                API_TOKEN: ${{ secrets.API_TOKEN }}
                SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
                VERSION: ${{ github.event.inputs.version }}
              run: |
                IFS=' ' read -ra TICKETS <<< "${{ steps.extract.outputs.tickets }}"
                if [[ -z "${TICKETS[*]}" ]]; then
                  echo "slack-message=‚ÑπÔ∏è Jira Ìã∞Ïºì ÏóÜÏùå. ÏóÖÎç∞Ïù¥Ìä∏ ÏÉùÎûµ." >> $GITHUB_OUTPUT
                  exit 0
                fi
      
                FAILED_TICKETS=()
                for TICKET in "${TICKETS[@]}"; do
                  echo "‚û°Ô∏è $TICKET FixVersion ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë..."
                  RESPONSE=$(curl -s -w "%{http_code}" -o response.json -u "$USER:$API_TOKEN" \
                    -X PUT -H "Content-Type: application/json" \
                    --data "{\"update\":{\"fixVersions\":[{\"add\":{\"name\":\"$VERSION\"}}]}}" \
                    "$DOMAIN/rest/api/2/issue/$TICKET")
      
                  if [[ "$RESPONSE" == "204" ]]; then
                    echo "‚úÖ $TICKET ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ"
                  elif [[ "$RESPONSE" == "401" || "$RESPONSE" == "403" ]]; then
                    echo "‚ùå Jira Ïù∏Ï¶ù Ïã§Ìå® ($RESPONSE)"
                    cat response.json
                    MSG="‚ùå *Jira Ïù∏Ï¶ù Ïã§Ìå®*\nÌã∞Ïºì: $TICKET\nÏÉÅÌÉú ÏΩîÎìú: $RESPONSE\nÏùëÎãµ:\n$(cat response.json)"
                    curl -X POST --data-urlencode "payload={\"username\": \"jira-bot\", \"text\": \"$MSG\", \"icon_emoji\": \":x:\"}" "$SLACK_WEBHOOK"
                    exit 1
                  else
                    echo "‚ùå $TICKET ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå® (ÏΩîÎìú: $RESPONSE)"
                    cat response.json
                    MSG="‚ö†Ô∏è *FixVersion ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®*\nÌã∞Ïºì: $TICKET\nÏÉÅÌÉú ÏΩîÎìú: $RESPONSE\nÏùëÎãµ:\n$(cat response.json)"
                    curl -X POST --data-urlencode "payload={\"username\": \"jira-bot\", \"text\": \"$MSG\", \"icon_emoji\": \":warning:\"}" "$SLACK_WEBHOOK"
                    FAILED_TICKETS+=("$TICKET")
                  fi
                  sleep 1
                done
      
                if [[ ${#FAILED_TICKETS[@]} -ne 0 ]]; then
                  echo "slack-message=‚ö†Ô∏è ÏùºÎ∂Ä Jira Ìã∞Ïºì ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${FAILED_TICKETS[*]}" >> $GITHUB_OUTPUT
                  exit 1
                fi
      
                echo "slack-message=üéâ Jira Fix Version ÏóÖÎç∞Ïù¥Ìä∏ ÏÑ±Í≥µ" >> $GITHUB_OUTPUT
>>>>>>> parent of f44e6d2 (Update AfterReleaseTagJob.yml)

      - name: Notify Jira update
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          MSG: ${{ steps.update-jira.outputs.slack-message }}
        run: |
          printf '%s\n' "$MSG"
          curl -X POST --data-urlencode "payload={\"username\":\"jira-bot\",\"text\":\"$MSG\",\"icon_emoji\":\":rocket:\"}" "$SLACK_WEBHOOK"

      - name: Send summary Slack message
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          VERSION: ${{ github.event.inputs.version }}
          TICKETS: ${{ steps.extract.outputs.tickets }}
          COMMITS_BASE64: ${{ steps.extract.outputs.commits_base64 }}
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          if [[ -z "$TICKETS" ]]; then
            MSG="‚ÑπÔ∏è No Jira tickets found for version $VERSION. No updates made."
          else
            COMMITS=$(echo "$COMMITS_BASE64" | base64 -d)

            FIXVERSION_LINK="$DOMAIN/issues/?jql=fixVersion=${VERSION}"
            MSG="üì¶ *Release $VERSION FixVersion ÏµúÏ¢Ö ÏöîÏïΩ*\n\n"
            MSG+="üîó <${FIXVERSION_LINK}|FixVersion: $VERSION>\n\n"

            MSG+="üé´ *Ìã∞Ïºì Î™©Î°ù:*\n"
            for TICKET in $TICKETS; do
              MSG+="‚Ä¢ <${DOMAIN}/browse/${TICKET}|${TICKET}>\n"
            done

            MSG+="\nüîÄ *Ìè¨Ìï®Îêú Ïª§Î∞ã:*\n"
            while IFS= read -r COMMIT; do
              MSG+="‚Ä¢ $COMMIT\n"
            done <<< "$COMMITS"
          fi

          echo "$MSG"
          curl -X POST --data-urlencode "payload={
            \"username\": \"jira-bot\",
            \"text\": \"$MSG\",
            \"icon_emoji\": \":memo:\"
          }" "$SLACK_WEBHOOK"
