name: Update Metadata

on:
  push:
    branches:
        - 'main'
        - 'master'
        - 'release*'  # release/ ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ë¸Œëœì¹˜
    paths:
      - 'jira-deployment/dev/**'
      - 'jira-deployment/prod/**'
      - 'jira-deployment/staging/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë©”íƒ€ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•  í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - prod
          - staging
          - dev

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    
    permissions:
      deployments: write
    
    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ë³€ê²½ëœ íŒŒì¼ í•„í„°ë§
      - name: Filter changed files
        id: changed-files
        uses: dorny/paths-filter@v2
        with:
          filters: |
            dev:
              - 'jira-deployment/dev/**'
            prod:
              - 'jira-deployment/prod/**'
            staging:
              - 'jira-deployment/staging/**'

      # 3. ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
      - name: List Changed Files
        run: |
          echo "ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:"
          git diff --name-only HEAD~1 HEAD -- | grep '^jira-deployment/' || true
          echo "----------------------------------------"
          git diff --name-only HEAD~1 HEAD -- | grep '^jira-deployment/' | while read -r file; do
            echo "ğŸ“„ íŒŒì¼: $file"
            echo "ë³€ê²½ ë‚´ìš©:"
            git diff HEAD~1 HEAD -- "$file" | cat
            echo "----------------------------------------"
          done

      # 4. Jira ì´ìŠˆ í‚¤ ì¶”ì¶œ
      - name: Extract Jira Issue Keys
        id: extract-keys
        run: |
          ISSUE_KEYS=$(git log -1 --pretty=%B | grep -oE '[A-Z]+-[0-9]+' || echo "No issue key found")
          echo "ğŸ“Œ ì¶”ì¶œëœ Jira Issue Keys: $ISSUE_KEYS"
          echo "issue-keys=$ISSUE_KEYS" >> $GITHUB_OUTPUT

      # 5. Dev Deployment ìƒì„±
      - name: Create Dev Deployment
        id: create-dev-deployment
        if: steps.changed-files.outputs.dev == 'true'
        uses: chrnorm/deployment-action@releases/v2
        with:
          token: ${{ github.token }}
          environment: dev
          ref: ${{ github.sha }}
          description: "Metadata update deployment to dev"

      # 6. Staging Deployment ìƒì„±
      - name: Create Staging Deployment
        id: create-staging-deployment
        if: steps.changed-files.outputs.staging == 'true'
        uses: chrnorm/deployment-action@releases/v2
        with:
          token: ${{ github.token }}
          environment: stage
          ref: ${{ github.sha }}
          description: "Metadata update deployment to stage"

      # 7. Prod Deployment ìƒì„±
      - name: Create Prod Deployment
        id: create-prod-deployment
        if: steps.changed-files.outputs.prod == 'true'
        uses: chrnorm/deployment-action@releases/v2
        with:
          token: ${{ github.token }}
          environment: prod
          ref: ${{ github.sha }}
          description: "Metadata update deployment to prod"

      # 8. Dev Deployment ìƒíƒœ ì—…ë°ì´íŠ¸
      - name: Update Dev Deployment Status
        if: steps.create-dev-deployment.outcome == 'success'
        uses: chrnorm/deployment-status@releases/v2
        with:
          token: ${{ github.token }}
          state: "success"
          deployment-id: ${{ steps.create-dev-deployment.outputs.deployment_id }}

      # 9. Staging Deployment ìƒíƒœ ì—…ë°ì´íŠ¸
      - name: Update Staging Deployment Status
        if: steps.create-staging-deployment.outcome == 'success'
        uses: chrnorm/deployment-status@releases/v2
        with:
          token: ${{ github.token }}
          state: "success"
          deployment-id: ${{ steps.create-staging-deployment.outputs.deployment_id }}

      # 10. Prod Deployment ìƒíƒœ ì—…ë°ì´íŠ¸
      - name: Update Prod Deployment Status
        if: steps.create-prod-deployment.outcome == 'success'
        uses: chrnorm/deployment-status@releases/v2
        with:
          token: ${{ github.token }}
          state: "success"
          deployment-id: ${{ steps.create-prod-deployment.outputs.deployment_id }}

      # 11. ì‹¤íŒ¨ ì‹œ Deployment ìƒíƒœ ì—…ë°ì´íŠ¸
      - name: Update Deployment Status on Failure
        if: failure()
        uses: chrnorm/deployment-status@releases/v2
        with:
          token: ${{ github.token }}
          state: "failure"
          deployment-id: ${{ steps.create-dev-deployment.outputs.deployment_id || steps.create-staging-deployment.outputs.deployment_id || steps.create-prod-deployment.outputs.deployment_id }}